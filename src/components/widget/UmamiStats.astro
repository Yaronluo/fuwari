---
import WidgetLayout from "./WidgetLayout.astro";

interface Props {
    class?: string;
    style?: string;
}
const { class: className, style } = Astro.props;
---

<WidgetLayout name="统计" id="umami-stats" class:list={[className]} {style}>
    <div class="text-center py-2">
        <div class="text-3xl font-bold text-neutral-900 dark:text-neutral-100" id="total-pageviews">-</div>
        <div class="text-sm text-neutral-500 dark:text-neutral-400">总浏览量</div>
    </div>
    <div class="grid grid-cols-2 divide-x divide-neutral-200 dark:divide-neutral-700 text-center pt-2">
        <div class="px-2">
            <div class="text-xl font-bold text-neutral-900 dark:text-neutral-100" id="total-visits">-</div>
            <div class="text-sm text-neutral-500 dark:text-neutral-400">访问数</div>
        </div>
        <div class="px-2">
            <div class="text-xl font-bold text-neutral-900 dark:text-neutral-100" id="total-visitors">-</div>
            <div class="text-sm text-neutral-500 dark:text-neutral-400">游客数</div>
        </div>
    </div>
</WidgetLayout>

<script>
    const UMAMI_CONFIG = {
        baseUrl: 'https://cloud.umami.is/share/ZbgwaMTu9qiNaoiy',
        websiteId: 'ZbgwaMTu9qiNaoiy',
        shareToken: '{"websiteId":"e66a9b4a-db37-4b02-91bc-5e2c01388ac8","token":"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ3ZWJzaXRlSWQiOiJlNjZhOWI0YS1kYjM3LTRiMDItOTFiYy01ZTJjMDEzODhhYzgiLCJpYXQiOjE3NjE4MzU3ODl9.YIFK9Maz6uhCGKibq1uyWhC2BRE6Zevp1xW2kLGPxRY"}'
    };

    function formatNumber(num: number): string {
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    }

    async function fetchUmamiStats() {
        try {
            const endAt = Date.now();
            const startAt = 0;

            const url = `${UMAMI_CONFIG.baseUrl}/websites/${UMAMI_CONFIG.websiteId}/stats?startAt=${startAt}&endAt=${endAt}&unit=hour&timezone=Asia%2FShanghai`;

            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'accept': 'application/json',
                    'x-umami-share-token': UMAMI_CONFIG.shareToken
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            const pageviewsElement = document.getElementById('total-pageviews');
            const visitsElement = document.getElementById('total-visits');
            const visitorsElement = document.getElementById('total-visitors');

            if (pageviewsElement) {
                pageviewsElement.textContent = formatNumber(data.pageviews || 0);
            }

            if (visitsElement) {
                visitsElement.textContent = formatNumber(data.visits || 0);
            }

            if (visitorsElement) {
                visitorsElement.textContent = formatNumber(data.visitors || 0);
            }

        } catch (error) {
            console.error('获取Umami统计数据失败:', error);
            const elements = ['total-pageviews', 'total-visits', 'total-visitors'];
            elements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = '获取失败';
                    element.classList.add('text-red-500');
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', fetchUmamiStats);

    if (window.swup) {
        window.swup.hooks.on('page:view', fetchUmamiStats);
    }
</script>